#==============================================================================
# Print Start — wait only if heating; safe guards for temp + homing
#==============================================================================
[gcode_macro PRINT_START]
gcode:
    _SET_FLAP_ENABLED ENABLED=1
    lights_max
    M220 S100
    G90

    # Params (safe defaults)
    {% set bedtemp         = params.BED|default(60)|int %}
    {% set hotendtemp      = params.HOTEND|default(210)|int %}
    {% set overshoot       = params.OVERSHOOT|default(8)|int %}  # allow up to +8°C over target
    {% set min_extrude     = printer.configfile.settings.extruder.min_extrude_temp|default(170)|int %}
    {% set nozzle_min_need = [hotendtemp, min_extrude]|max %}

    # Heat non-blocking so we can do setup while temps rise
    M140 S{bedtemp}
    M104 S{hotendtemp}

    # Home early (reduces ooze time parked hot)
    G28
    _CLIENT_LINEAR_MOVE Z=5 F=1500
    ; BED_MESH_CALIBRATE ADAPTIVE=0
    ; NOZZLE_WIPE_LOCATION_READY

    # Waits that block only if BELOW target (no cooldown wait)
    TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={bedtemp}
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={nozzle_min_need} MAXIMUM={hotendtemp + overshoot}

    # Safety: ensure we're still homed (in case of prior abort)
    {% if not printer.toolhead.homed_axes|lower == "xyz" %}
      G28
    {% endif %}

    # Now it's safe to extrude
    ; NOZZLE_WIPE
    PRIME_LINE
