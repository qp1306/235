# --- at the top of PRINT_START params ---
{% set bedtemp    = params.BED|default(60)|int %}
{% set hotendtemp = params.HOTEND|default(210)|int %}
{% set tol        = params.TOL|default(5)|int %}      # ±°C tolerance window
{% set min_extrude = printer.configfile.settings.extruder.min_extrude_temp|default(170)|int %}

# ... heat non-blocking, home, lift, etc. ...

# Bed: only wait if below (optionally allow a small below-target tolerance too)
{% if printer.heater_bed.temperature < bedtemp - tol %}
  TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={{ bedtemp - tol }}
{% endif %}

# Nozzle “smart wait” with tolerance:
# 1) If already within [hotend - tol, hotend + tol] → don't wait
# 2) If above by more than tol → (optional) wait down to hotend + tol
# 3) If below by more than tol → heat & wait to hotend
{% if printer.extruder.temperature > hotendtemp + tol %}
  TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={{ hotendtemp + tol }}
{% elif printer.extruder.temperature < hotendtemp - tol %}
  M109 S{hotendtemp}
{% else %}
  ; already within tolerance band → proceed
{% endif %}

# Safety: make sure we're not under min_extrude_temp
{% if printer.extruder.temperature < min_extrude %}
  M109 S{min_extrude}
{% endif %}
