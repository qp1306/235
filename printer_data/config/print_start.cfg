#==============================================================================
# PRINT_START with tolerant band + final guard (heater=extruder)
#==============================================================================
[gcode_macro PRINT_START]
description: Start when nozzle is close enough but never below min_extrude_temp
gcode:
    {% set bedtemp     = params.BED|int %}
    {% set hotendtemp  = params.HOTEND|int %}
    {% set tol_below   = (params.TOL_BELOW|default(10))|int %}
    {% set tol_above   = (params.TOL_ABOVE|default(5))|int %}
    {% set min_extrude = (printer.configfile.settings.extruder.min_extrude_temp|default(170))|int %}
    {% set eff_target  = [hotendtemp, min_extrude]|max %}
    {% set lower_bound = [min_extrude, eff_target - tol_below, 0]|max %}
    {% set upper_bound = eff_target + tol_above %}
    {% if lower_bound > upper_bound %}{% set upper_bound = lower_bound %}{% endif %}

    { action_respond_info(
        "PRINT_START: BED=%d HOTEND=%d eff_target=%d min_extrude=%d band=[%d..%d]"
        % (bedtemp, hotendtemp, eff_target, min_extrude, lower_bound, upper_bound)
      ) }

    _SET_FLAP_ENABLED ENABLED=1
    lights_max
    M220 S100
    G90

    ; Heat bed first
    M104 S155
    M190 S{bedtemp}

    ; Home & safe Z lift
    G28
    _CLIENT_LINEAR_MOVE Z=5 F=1500
    M190 S{bedtemp}

    ; Heat to effective target and wait within safe band
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET={eff_target}
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={lower_bound} MAXIMUM={upper_bound}

    ; Final homing sanity (in case a prior error interrupted)
    {% if "xyz" not in printer.toolhead.homed_axes %} G28 {% endif %}

    ; Hand off to purge (the purge macro enforces â‰¥min_extrude again)
    PRIME_LINE
