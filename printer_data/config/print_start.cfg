#==============================================================================
# PRINT_START with tolerant temperature band (safe & guarded)
# Usage: PRINT_START BED=60 HOTEND=250 [TOL_BELOW=10] [TOL_ABOVE=5]
#==============================================================================
[gcode_macro PRINT_START]
description: Start quickly when nozzle is "close enough" while guarding homing & min_extrude_temp
gcode:
    {% set bedtemp      = params.BED|int %}
    {% set hotendtemp   = params.HOTEND|int %}
    {% set tol_below    = (params.TOL_BELOW|default(10))|int %}
    {% set tol_above    = (params.TOL_ABOVE|default(5))|int %}
    {% set min_extrude  = (printer.configfile.settings.extruder.min_extrude_temp|default(170))|int %}
    {% set lower_bound  = [min_extrude, hotendtemp - tol_below, 0]|max %}
    {% set upper_bound  = hotendtemp + tol_above %}

    _SET_FLAP_ENABLED ENABLED=1
    lights_max
    M220 S100
    G90

    ; ---- Heat bed first (keeps ooze down) ----
    M104 S155
    M190 S{bedtemp}

    ; ---- Basic home & safe Z lift ----
    G28
    _CLIENT_LINEAR_MOVE Z=5 F=1500
    M190 S{bedtemp}                     ; re-affirm bed if your profile changes it

    ; ---- Set extruder target, then tolerant wait (NEVER below min_extrude_temp) ----
    M104 S{hotendtemp}
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={lower_bound} MAXIMUM={upper_bound}

    ; ---- Final safety checks right BEFORE any motion/extrusion ----
    {% if "xyz" not in printer.toolhead.homed_axes %}
      G28
    {% endif %}
    M109 S{hotendtemp} R{lower_bound}   ; ensure we're at/above lower_bound (completes instantly if already)
    M83                                  ; relative extrusion
    G92 E0

    ; ---- Your pre-print routine ----
    ; NOZZLE_WIPE_LOCATION_READY
    ; NOZZLE_WIPE
    PRIME_LINE
